"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.replaceImports=void 0;var _strBeforeLast=require("../utilities/strBeforeLast"),_makeFilepath=require("../utilities/makeFilepath"),_testFilesystem=require("test-filesystem"),_main=require("../main"),_regexEscape=require("../utilities/regexEscape"),_makeRelativePath=require("../utilities/makeRelativePath");const replaceImports=(e,t,s={})=>(r,i)=>{if(!i.file)return console.error("Unable to find module",e,i),r;let a=(0,_makeRelativePath.makeRelativePath)(e,i.file),l=t;(l.endsWith(".js")||l.endsWith(".mjs"))&&(l=(0,_strBeforeLast.strBeforeLast)(l,"/"));let o=(0,_makeFilepath.makeFilepath)(l,a);o.endsWith(".mjs")&&(o=(0,_strBeforeLast.strBeforeLast)(o,".mjs")+".js"),(0,_testFilesystem.fileExists)(o)||((o.endsWith(".js")||o.endsWith(".mjs"))&&(o=(0,_strBeforeLast.strBeforeLast)(o,"/")),(0,_main.makeCommon)(i.file,o,s));const m=(0,_regexEscape.regexEscape)(i.module),p=new RegExp(`(['"\`])${m}['"\`]`);if(i.module.includes("${")){const e=m.replace(/(\\\$\\{.+\\})+/g,".+"),t=new RegExp(`(.+/)(${e})(/.+)`,"g");a=a.replace(t,"$1"+i.module+"$3")}return a.endsWith(".mjs")&&(a=(0,_strBeforeLast.strBeforeLast)(a,".mjs")+".js"),/^\.+\//.test(a)||(a=`./${a}`),r.replace(p,`$1${a}$1`)};exports.replaceImports=replaceImports;